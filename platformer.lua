-- title:  testing
-- author: desttinghim
-- desc:   trying out tic80
-- script: lua

local tiny = require "tiny"
local Anim = require "anim"

local drawingSystem = tiny.processingSystem()
drawingSystem.filter = tiny.requireAll(
  "transform", "sprite"
)
function drawingSystem:preProcess(dt)
    cls(0)
end
function drawingSystem:process(e, dt)
    local transparent = 0
    spr(
        e.sprite.i,
        e.transform.x - e.sprite.xoff,
        e.transform.y - e.sprite.yoff,
        transparent,
        e.sprite.scale,
        e.sprite.flip,
        e.sprite.rot,
        e.sprite.w,
        e.sprite.h
    )
end

local animSystem = tiny.processingSystem()
animSystem.filter = tiny.filter(
  "(sprite&anim)|(sprite&anim&control)"
)
function animSystem:process(e, dt)
  if e.control then
    if e.control.left then e.sprite.flip = 1 end
    if e.control.right then e.sprite.flip = 0 end
    if e.control.up then e.anim:play("jump")
    elseif e.control.down then e.anim:play("fall")
    elseif e.control.left or e.control.right then e.anim:play("walk")
    else e.anim:play("still") end
  end
  local index = e.anim:update(dt)
  if index then e.sprite.i = index end
end

local controlSystem = tiny.processingSystem()
controlSystem.filter = tiny.requireAll("control")
function controlSystem:process(e, dt)
  if e.control.controller < 4 then
    local offset = e.control.controller * 8
    -- basic controls
    e.control.up = btn(offset)
    e.control.down = btn(offset + 1)
    e.control.left = btn(offset + 2)
    e.control.right = btn(offset + 3)
    e.control.a = btn(offset + 4)
    e.control.b = btn(offset + 5)
    e.control.x = btn(offset + 6)
    e.control.y = btn(offset + 7)
    -- actions
    e.control.jump = btnp(offset) or btnp(offset + 4)
  end
end

local player = {
    transform = {
        x = 80,
        y = 80,
    },
    sprite = {
        i = 256,
        xoff = 4,
        yoff = 4,
        w = 1,
        h = 1,
        flip = 0,
        scale = 1,
        rot = 0,
    },
    anim = Anim.new({
      still = Anim.still(256),
      walk = Anim.simple(5, {257,258,259,260}),
      jump = Anim.still(261),
      fall = Anim.still(262),
    }, "still"),
    control = {
      controller = 0,
    },
}

local world = tiny.world(drawingSystem, animSystem, controlSystem, player)

function TIC()
 world:update(1)
end

-- <TILES>
-- 018:00000000000000000000000000000000000c0000000000000cc00c0ccccccccc
-- 020:0cccccccccc0000cc0000c00c0000000c0000000cc0c0000cc000000c0000000
-- 021:ccccccc00ccc0c0c0000000c00c000cc0000000c0000c00c000000cc0000000c
-- 033:0000000c000000cc000000cc0000000c0000c00c000000cc000000cc0000000c
-- 035:c0000000c00c0000cc000000c0000000c00c0000c0000000cc000000cc000000
-- 036:c0c00000c0000000cc000000cc000000c000c000c0000000cc0c000c0ccccccc
-- 037:0000000c000000cc000000cc0000c00c0c00000c0000000c0c0c0cccccccccc0
-- 050:cccccccc0c000c0c0000000000c0000000000000000000000000000000000000
-- 255:dccccccdcc2cc2cccc2cc2cccc2cc2cccc2cc2cccccccccccc2cc2ccdccccccd
-- </TILES>

-- <SPRITES>
-- 000:00000000000dd000000dd00000dddd000cdddde00cdddde000c00e0000c00e00
-- 001:00000000000dd000000dd00000dddd000cdddde0c0dddd0e000cc0000000e000
-- 002:00000000000dd000000dd0000cdddde0c0dddd0e00dddd00000ce000000ec000
-- 003:00000000000dd000000dd00000dddd000cdddde0c0dddd0e000cee00000c0000
-- 004:00000000000dd000000dd00000dddd0000cddd0000dcdd0000c00e0000c00e00
-- 005:00000000000dd000000dd0000cdddde0c0dddd0e00dddd000cc00e0000000e00
-- 006:000dd000c00dd00e0cdddde000dddd0000dddde000c000e000c0000000000000
-- </SPRITES>

-- <MAP>
-- 001:000021212121212121212121212121212121212121212121212121210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 002:001200000000000000000000000000000000000000000000000000003200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 003:001200000000000000000000000000000000000000000000000000003200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 004:001200000000000000000000000000000000000000000000000000003200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 005:001200000000000000000000000000000000000000000000000000003200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 006:001200000000000000000000000000000000000000000000000000003200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 007:001200000000000000000000000000000000000000000000000000003200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 008:001200000000000000000000000000000000000000000000000000003200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 009:001200000000000000000000000000000000000000000000000000003200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 010:000023232323235100000000000000000000000000000000000000003200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 011:000000000000215200000000000000000000000000000000000000003200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 012:000000002152000000000000000000000000000000000000000000003200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 013:000021520000000000000000000041510000000000000000000000003200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 014:001200000000000000000000412300005100000000000000000000003200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 015:000023232323232323232323000000000023232323232323232323230000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </MAP>

-- <WAVES>
-- 000:00000000ffffffff00000000ffffffff
-- 001:0123456789abcdeffedcba9876543210
-- 002:0123456789abcdef0123456789abcdef
-- </WAVES>

-- <SFX>
-- 000:010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100300000000000
-- </SFX>

-- <PATTERNS>
-- 000:400018000000000000100000400018000000000000100000600018000000000000100000400018000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </PATTERNS>

-- <TRACKS>
-- 000:100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </TRACKS>

-- <FLAGS>
-- 000:00000000000000000000000000000000000010001010000000000000000000000010001010100000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </FLAGS>

-- <PALETTE>
-- 000:1a1c2c5d275db13e53ef7d57ffcd75a7f07038b76425717929366f3b5dc941a6f673eff7f4f4f494b0c2566c86333c57
-- </PALETTE>

